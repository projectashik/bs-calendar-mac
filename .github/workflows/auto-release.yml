name: Auto Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from commit
        id: version
        run: |
          # Use short commit SHA as version
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      - name: Build App
        run: |
          xcodebuild -project bs-calendar.xcodeproj \
                     -scheme bs-calendar \
                     -configuration Release \
                     -derivedDataPath build \
                     CODE_SIGN_IDENTITY="-" \
                     CODE_SIGNING_ALLOWED=YES
      
      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/bs-calendar.app"
          DMG_NAME="bs-calendar-macos.dmg"
          TEMP_DMG="temp.dmg"
          VOLUME_NAME="BS Calendar"
          
          # Ad-hoc sign the app (required for Gatekeeper)
          echo "ðŸ” Signing app with ad-hoc signature..."
          codesign --force --deep --sign - "${APP_PATH}"
          
          # Verify signature
          codesign --verify --verbose "${APP_PATH}"
          
          # Create temporary DMG (50MB)
          hdiutil create -size 50m -fs HFS+ -volname "${VOLUME_NAME}" "${TEMP_DMG}"
          
          # Mount the DMG
          hdiutil attach "${TEMP_DMG}" -mountpoint "/Volumes/${VOLUME_NAME}"
          
          # Copy app to DMG
          cp -R "${APP_PATH}" "/Volumes/${VOLUME_NAME}/"
          
          # Create Applications symlink for drag-and-drop
          ln -s /Applications "/Volumes/${VOLUME_NAME}/Applications"
          
          # Set DMG window appearance
          echo '
          tell application "Finder"
            tell disk "'${VOLUME_NAME}'"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set the bounds of container window to {100, 100, 600, 400}
              set viewOptions to the icon view options of container window
              set arrangement of viewOptions to not arranged
              set icon size of viewOptions to 100
              set position of item "bs-calendar.app" of container window to {120, 150}
              set position of item "Applications" of container window to {380, 150}
              update without registering applications
              delay 2
              close
            end tell
          end tell
          ' | osascript
          
          # Unmount
          hdiutil detach "/Volumes/${VOLUME_NAME}"
          
          # Convert to compressed, read-only DMG
          hdiutil convert "${TEMP_DMG}" -format UDZO -o "${DMG_NAME}"
          
          # Clean up
          rm -f "${TEMP_DMG}"
          
          # Get file size
          SIZE=$(du -h ${DMG_NAME} | cut -f1)
          echo "DMG created: ${DMG_NAME} (${SIZE})"
          echo "size=${SIZE}" >> $GITHUB_OUTPUT
        id: package
      
      - name: Delete old releases (keep last 5)
        run: |
          # Get all releases except the latest 5
          gh release list --limit 100 --json tagName,createdAt -q '.[5:] | .[].tagName' | while read tag; do
            echo "Deleting old release: $tag"
            gh release delete "$tag" -y || true
          done
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: BS Calendar ${{ steps.version.outputs.version }}
          body: |
            ## ðŸŽ‰ Auto-build from latest commit
            
            **Version:** `${{ steps.version.outputs.version }}`  
            **Built:** ${{ steps.version.outputs.timestamp }}  
            **Commit:** ${{ github.sha }}
            
            ---
            
            ## ðŸ“¥ Download
            
            **File:** `bs-calendar-macos.dmg` (${{ steps.package.outputs.size }})
            
            ## ðŸš€ Installation
            
            1. Download `bs-calendar-macos.dmg` below
            2. Open the DMG file
            3. Drag `bs-calendar.app` to the **Applications** folder
            4. Eject the DMG
            5. Launch from Applications (or Spotlight)
            
            > **âš ï¸ Important:** This app is **ad-hoc signed** (not notarized). On first launch:
            > 1. Right-click the app â†’ **Open** 
            > 2. Click **Open** in the dialog
            > 
            > Or run in Terminal: `xattr -cr /Applications/bs-calendar.app && open /Applications/bs-calendar.app`
            
            ## âœ¨ Features
            
            - ðŸ“… Menu bar Nepali calendar display
            - ðŸ‡³ðŸ‡µ Nepali numerals support (à¥¦à¥§à¥¨à¥©)
            - ðŸŽ¨ Auto Light/Dark theme
            - ðŸš€ Launch at login option
            - âš¡ Lightweight (< 20MB RAM)
            
            ## ðŸ“‹ Requirements
            
            - macOS 13.0 (Ventura) or later
            - Apple Silicon or Intel Mac
            
            ---
            
            ### ðŸ“ Recent Changes
            
            ${{ github.event.head_commit.message }}
            
            **Changed files:**
            ```
            ${{ github.event.commits[0].modified }}
            ```
          files: bs-calendar-macos.dmg
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Success Summary
        run: |
          echo "âœ… Build successful!"
          echo "ðŸ“¦ Version: ${{ steps.version.outputs.version }}"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          echo "ðŸ“¥ Download: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/bs-calendar-macos.dmg"
